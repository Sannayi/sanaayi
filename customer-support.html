<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sanaayi | Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #ff5a00;
            --primary-soft: #fff5f0;
            --bg: #f3f4f6;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --success: #10b981;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg);
            margin: 0;
            color: var(--text-main);
            padding-bottom: 40px;
        }

        /* Ù‡ÙŠØ¯Ø± Ø¹ØµØ±ÙŠ */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, #ff8b4d 100%);
            color: white;
            padding: 50px 20px 60px;
            text-align: center;
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 30px rgba(255, 90, 0, 0.2);
        }
        .header h1 { margin: 0; font-size: 28px; font-weight: 900; }
        .header p { margin: 10px 0 0; opacity: 0.9; font-size: 15px; }

        .container { max-width: 450px; margin: -30px auto 0; padding: 0 15px; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„ÙƒØ±ÙˆØª */
        .card {
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04);
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.02);
            transition: 0.3s;
        }
        .card:hover {
            box-shadow: 0 12px 30px rgba(255, 90, 0, 0.1);
        }

        h3 { 
            margin: 0 0 15px; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            color: var(--primary);
        }

        /* Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ø§Ù„Ù…Ø·ÙˆØ±Ø© */
        .faq-item {
            background: #f9fafb;
            border-radius: 15px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: 0.3s;
        }
        .faq-question {
            padding: 15px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            padding: 0 15px;
            color: var(--text-muted);
            font-size: 13px;
            line-height: 1.6;
            transition: all 0.3s ease-out;
        }
        .faq-item.active { background: var(--primary-soft); }
        .faq-item.active .faq-answer { max-height: 200px; padding-bottom: 15px; }
        .faq-item.active i { transform: rotate(180deg); color: var(--primary); }

        /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø´ÙƒÙˆÙ‰ */
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-size: 13px; 
            font-weight: 600; 
            color: var(--text-muted);
        }
        input, textarea, select {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1.5px solid #eee;
            border-radius: 12px;
            background: #f9fafb;
            font-family: inherit;
            transition: 0.3s;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--primary);
            background: white;
            outline: none;
            box-shadow: 0 0 0 4px rgba(255, 90, 0, 0.1);
        }

        .btn-submit {
            background: var(--primary);
            color: white;
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 15px;
            font-weight: 800;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 90, 0, 0.2);
            transition: 0.3s;
        }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Ø²Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-preview {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8d9 100%);
            padding: 18px;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid rgba(255, 90, 0, 0.1);
            position: relative;
            transition: 0.3s;
        }
        .chat-preview:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 90, 0, 0.15);
        }
        .chat-preview .icon-box {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .online-badge {
            width: 12px;
            height: 12px;
            background: #22c55e;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            bottom: 18px;
            right: 60px;
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        #userStatus {
            text-align: center;
            margin-bottom: 20px;
            padding: 12px;
            background: white;
            border-radius: 30px;
            font-size: 13px;
            color: var(--text-muted);
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .loading-dots:after { 
            content: ' .'; 
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 
            0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 
            40% { color: #555; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0); } 
            60% { text-shadow: .25em 0 0 #555, .5em 0 0 rgba(0,0,0,0); } 
            80%, 100% { text-shadow: .25em 0 0 #555, .5em 0 0 #555; } 
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification-badge {
            background: var(--primary);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 20px;
            margin-right: 10px;
        }

        /* ØªØ°Ø§ÙƒØ±ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© */
        .previous-tickets {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .ticket-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
        }
        .status-pending { background: rgba(255, 90, 0, 0.1); color: var(--primary); }
        .status-resolved { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    </style>
</head>
<body>

<div class="header">
    <h1>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</h1>
    <p>Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø© Ù„Ùƒ</p>
</div>

<div class="container">
    
    <div id="userStatus" class="loading-dots">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‡ÙˆÙŠØ©</div>

    <div class="card">
        <h3><i class="fa-solid fa-headset"></i> Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
        <div class="chat-preview" onclick="startChat()">
            <div class="icon-box"><i class="fa-solid fa-comments"></i></div>
            <div class="online-badge"></div>
            <div>
                <strong style="font-size: 15px;">ØªØ­Ø¯Ø« Ù…Ø¹ Ù…ÙˆØ¸Ù Ø§Ù„Ø¯Ø¹Ù…</strong><br>
                <small style="color: #ff5a00; font-weight: 700;">Ù…ØªÙˆØ§Ø¬Ø¯ÙˆÙ† Ø§Ù„Ø¢Ù†</small>
            </div>
        </div>
        
        <!-- Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ù…Ø­Ø§Ø¯Ø«Ø© -->
        <div id="lastChatPreview" style="display: none; margin-top: 15px; padding: 10px; background: #f9fafb; border-radius: 12px;">
            <small style="color: var(--text-muted);">Ø¢Ø®Ø± Ù…Ø­Ø§Ø¯Ø«Ø©:</small>
            <p id="lastChatMessage" style="margin: 5px 0; font-size: 13px;"></p>
            <button class="btn-submit" style="padding: 8px; font-size: 13px;" onclick="continueChat()">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
        </div>
    </div>

    <div class="card">
        <h3><i class="fa-solid fa-circle-question"></i> Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</h3>
        <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
                ÙƒÙŠÙ Ø£Ø¶Ù…Ù† Ø­Ù‚ÙŠ Ù…Ø¹ Ø§Ù„ÙÙ†ÙŠØŸ 
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="faq-answer">
                Ù†Ø­Ù† Ù†Ø±Ø§Ù‚Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª. Ù†Ù†ØµØ­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø®Ù„Ø§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù†ØµØ© ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø·Ù„Ø¨ Ø¨ØµÙˆØ±Ø© Ù„Ù„Ø¹Ù…Ù„ Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ù„Ø¶Ù…Ø§Ù† Ø­Ù‚Ùƒ ÙƒØ§Ù…Ù„Ø§Ù‹.
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
                Ù…Ø§Ø°Ø§ Ø£ÙØ¹Ù„ Ø¥Ø°Ø§ ØªØ£Ø®Ø± Ø§Ù„ÙÙ†ÙŠØŸ 
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="faq-answer">
                ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„ÙÙ†ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØŒ ÙˆØ¥Ø°Ø§ Ù„Ù… ÙŠØ³ØªØ¬Ø¨ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø´ÙƒÙˆÙ‰ "ØªØ£Ø®ÙŠØ±" ÙˆØ³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚Ù†Ø§ Ø¨Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ù…Ø± ÙÙˆØ±Ø§Ù‹.
            </div>
        </div>
        <div class="faq-item">
            <div class="faq-question" onclick="toggleFaq(this)">
                ÙƒÙŠÙ Ø£ØªØªØ¨Ø¹ Ø´ÙƒÙˆØªÙŠØŸ 
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="faq-answer">
                Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰ØŒ Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ù‚Ø³Ù… "ØªØ°Ø§ÙƒØ±ÙŠ" Ø¨Ø§Ù„Ø£Ø³ÙÙ„. ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„ØªÙ‡Ø§ ÙˆØ³ØªØµÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¯.
            </div>
        </div>
    </div>

    <div class="card">
        <h3>
            <i class="fa-solid fa-clipboard-list"></i> 
            ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©
        </h3>
        <form id="complaintForm">
            <label>Ù…Ø§ Ù‡ÙŠ Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ</label>
            <select id="compType" required>
                <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                <option value="ØªØ£Ø®ÙŠØ±">â° ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„Ù…ÙˆØ¹Ø¯</option>
                <option value="Ø³ÙˆØ¡ ØªÙ†ÙÙŠØ°">ğŸ”§ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¹Ù…Ù„</option>
                <option value="Ø³Ù„ÙˆÙƒ">ğŸ˜¤ Ø³Ù„ÙˆÙƒ ØºÙŠØ± Ù„Ø§Ø¦Ù‚</option>
                <option value="Ø³Ø¹Ø±">ğŸ’° Ø®Ù„Ø§Ù Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙ„ÙØ©</option>
                <option value="Ø£Ø®Ø±Ù‰">ğŸ“Œ Ø³Ø¨Ø¨ Ø¢Ø®Ø±</option>
            </select>

            <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="text" id="orderNumber" placeholder="Ù…Ø«Ø§Ù„: #12345">

            <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
            <textarea id="compDetails" rows="4" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ù…Ø§ Ø­Ø¯Ø« Ù…Ø¹Ùƒ Ø¨Ø§Ù„ØªÙØµÙŠÙ„..." required></textarea>

            <button type="submit" class="btn-submit" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
        </form>
    </div>

    <!-- ØªØ°Ø§ÙƒØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
    <div class="card" id="userTicketsSection" style="display: none;">
        <h3>
            <i class="fa-solid fa-ticket"></i>
            ØªØ°Ø§ÙƒØ±ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            <span id="ticketsCount" class="notification-badge">0</span>
        </h3>
        <div id="userTicketsList">
            <p style="text-align: center; color: var(--text-muted); font-size: 13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø³Ø§Ø¨Ù‚Ø©</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        serverTimestamp,
        onSnapshot,
        query,
        where,
        orderBy,
        doc,
        updateDoc,
        getDocs
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBuFYQuJxjinz7_0yTCTO-0jnvjeg-iXoQ",
        authDomain: "sanaayi.firebaseapp.com",
        projectId: "sanaayi",
        storageBucket: "sanaayi.firebasestorage.app",
        messagingSenderId: "657863522339",
        appId: "1:657863522339:web:f7ad44ca81147d0d519996"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let activeUser = null;
    let unsubscribeTickets = null;

    // ğŸ›¡ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø°ÙƒÙŠ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    onAuthStateChanged(auth, async (user) => {
    const statusDiv = document.getElementById('userStatus');
    
    if (user) {
        activeUser = user;
        statusDiv.innerHTML = `
            <i class="fa-solid fa-circle-check" style="color:#22c55e"></i> 
            Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.displayName || user.email || 'Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²'}
        `;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        document.getElementById('userTicketsSection').style.display = 'block';
        
        // 1. ØªØ­Ù…ÙŠÙ„ ØªØ°Ø§ÙƒØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        loadUserTickets(user.uid);
        
        // 2. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ°Ø§ÙƒØ± (Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø¯Ø§Ù„Ø©)
        listenToReplies(user.uid);
        
        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ø³Ø§Ø¨Ù‚Ø©
        checkLastChat(user.uid);
        
        // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ
        localStorage.setItem('currentUser', JSON.stringify({
            uid: user.uid,
            email: user.email,
            name: user.displayName || 'Ø¹Ù…ÙŠÙ„'
        }));
        
    } else {
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù†Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„
        try {
            await signInAnonymously(auth);
            console.log("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ù…Ø¬Ù‡ÙˆÙ„");
        } catch (error) {
            statusDiv.innerHTML = `
                <i class="fa-solid fa-circle-exclamation" style="color:#ef4444"></i> 
                ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
            `;
        }
    }
});


    // ØªØ­Ù…ÙŠÙ„ ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·
    async function loadUserTickets(userId) {
        if (unsubscribeTickets) {
            unsubscribeTickets();
        }

       // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
const ticketsQuery = query(
    collection(db, "support_tickets"),
    where("userId", "==", userId)
);
// Ø«Ù… Ù‚Ù… Ø¨ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù€ JavaScript (Client-side sorting)


        unsubscribeTickets = onSnapshot(ticketsQuery, (snap) => {
            const ticketsList = document.getElementById('userTicketsList');
            const ticketsCount = document.getElementById('ticketsCount');
            
            if (snap.empty) {
                ticketsList.innerHTML = '<p style="text-align: center; color: var(--text-muted); font-size: 13px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø³Ø§Ø¨Ù‚Ø©</p>';
                ticketsCount.textContent = '0';
            } else {
                ticketsCount.textContent = snap.size;
                
                let html = '';
                snap.forEach(d => {
                    const t = d.data();
                    const ticketId = d.id;
                    
                    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
                    let dateText = 'Ù‚Ø±ÙŠØ¨Ø§Ù‹';
                    if (t.createdAt?.toDate) {
                        const date = t.createdAt.toDate();
                        dateText = date.toLocaleDateString('ar-EG', {
                            day: 'numeric',
                            month: 'short',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    
                    const statusClass = t.status === 'resolved' ? 'status-resolved' : 'status-pending';
                    const statusText = t.status === 'resolved' ? 'ØªÙ… Ø§Ù„Ø­Ù„' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                    
                    html += `
                        <div style="background: #f9fafb; border-radius: 15px; padding: 12px; margin-bottom: 10px; border-right: 3px solid ${t.status === 'resolved' ? '#10b981' : '#ff5a00'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="font-size: 13px;">${t.type || 'Ø§Ø³ØªÙØ³Ø§Ø±'}</strong>
                                <span class="ticket-status ${statusClass}">${statusText}</span>
                            </div>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 5px 0;">${t.details || t.description || ''}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <small style="color: var(--text-muted);">ğŸ• ${dateText}</small>
                                ${t.status !== 'resolved' ? 
                                    '<small style="color: var(--primary);">âš¡ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø¯</small>' : 
                                    '<small style="color: var(--success);">âœ… ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</small>'
                                }
                            </div>
                        </div>
                    `;
                });
                ticketsList.innerHTML = html;
            }
        });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¢Ø®Ø± Ù…Ø­Ø§Ø¯Ø«Ø©
    async function checkLastChat(userId) {
        try {
            const chatRef = doc(db, "admin_chats", userId);
            const chatSnap = await getDocs(query(collection(db, "admin_chats"), where("__name__", "==", userId)));
            
            if (!chatSnap.empty) {
                const chatData = chatSnap.docs[0].data();
                const lastMessage = chatData.lastMessage || 'Ø§Ù†Ù‚Ø± Ù„Ù…ÙˆØ§ØµÙ„Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©';
                
                document.getElementById('lastChatPreview').style.display = 'block';
                document.getElementById('lastChatMessage').textContent = lastMessage;
            }
        } catch (error) {
            console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©");
        }
    }

    // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    window.toggleFaq = (el) => {
        const item = el.parentElement;
        item.classList.toggle('active');
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰
    document.getElementById('complaintForm').onsubmit = async (e) => {
        e.preventDefault();
        
        if(!activeUser) {
            return Swal.fire({
                icon: 'error',
                title: 'ØºÙŠØ± Ù…ØµØ±Ø­',
                text: 'Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹.',
                confirmButtonColor: '#ff5a00'
            });
        }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

        try {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¥Ù„Ù‰ Firestore
            const ticketData = {
                userId: activeUser.uid,
                userEmail: activeUser.email,
                userName: activeUser.displayName || "Ø¹Ù…ÙŠÙ„ ØµÙ†Ø§ÙŠØ¹ÙŠ",
                type: document.getElementById('compType').value,
                orderNo: document.getElementById('orderNumber').value,
                details: document.getElementById('compDetails').value,
                status: "pending",
                createdAt: serverTimestamp(),
                lastUpdate: serverTimestamp()
            };

            await addDoc(collection(db, "support_tickets"), ticketData);

            // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
            Swal.fire({
                icon: 'success',
                title: 'ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø´ÙƒÙˆØ§Ùƒ',
                text: 'Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.',
                confirmButtonColor: '#ff5a00',
                timer: 3000
            });
            
            e.target.reset();
            
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„',
                text: error.message,
                confirmButtonColor: '#ff5a00'
            });
        } finally {
            btn.disabled = false;
            btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒØ±Ø©";
        }
    };

    // Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    window.startChat = async () => {
        if (!activeUser) {
            Swal.fire({
                icon: 'warning',
                title: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨',
                text: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø©...',
                confirmButtonColor: '#ff5a00'
            });
            return;
        }

        try {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            const chatRef = doc(db, "admin_chats", activeUser.uid);
            await updateDoc(chatRef, {
                lastMessage: "Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                lastUpdate: serverTimestamp(),
                userActive: true,
                adminUnread: true
            }).catch(async () => {
                // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ù†Ø´Ø¦Ù‡
                await addDoc(collection(db, "admin_chats"), {
                    userId: activeUser.uid,
                    lastMessage: "Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©",
                    lastUpdate: serverTimestamp(),
                    userActive: true,
                    adminUnread: true
                });
            });

            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            window.location.href = `chat.html?userId=${activeUser.uid}&role=user&name=${encodeURIComponent(activeUser.displayName || 'Ø¹Ù…ÙŠÙ„')}`;
            
        } catch (error) {
            Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ' + error.message, 'error');
        }
    };

    // Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø³Ø§Ø¨Ù‚Ø©
    window.continueChat = () => {
        if (activeUser) {
            window.location.href = `chat.html?userId=${activeUser.uid}&role=user&name=${encodeURIComponent(activeUser.displayName || 'Ø¹Ù…ÙŠÙ„')}`;
        }
    };

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ°Ø§ÙƒØ± (Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª)
    // Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£Ø®ÙŠØ± ÙÙŠ ÙƒÙˆØ¯ ØµÙØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯
async function listenToReplies(userId) {
    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹
    const userTickets = await getDocs(query(collection(db, "support_tickets"), where("userId", "==", userId)));
    const ticketIds = userTickets.docs.map(doc => doc.id);

    if (ticketIds.length > 0) {
        const repliesQuery = query(
            collection(db, "ticket_replies"),
            where("ticketId", "in", ticketIds)
        );
        
        onSnapshot(repliesQuery, (snap) => {
            if (!snap.empty && !snap.metadata.hasPendingWrites) {
                Swal.fire({
                    icon: 'info',
                    title: 'Ù„Ø¯ÙŠÙƒ Ø±Ø¯ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…',
                    text: 'ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© ØªØ°Ø§ÙƒØ±Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©',
                    confirmButtonColor: '#ff5a00'
                });
            }
        });
    }
}


    // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('beforeunload', () => {
        if (unsubscribeTickets) {
            unsubscribeTickets();
        }
    });

</script>
</body>
</html>
